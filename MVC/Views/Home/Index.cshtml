@model MVC.Models.SearchViewModel
@{
    ViewData["Title"] = "Tìm kiếm chuyến bay";
}

<div class="container my-5">
    <div class="row">
        <div class="col-md-10 col-lg-8 mx-auto">
            <h1 class="text-center mb-4">Tìm chuyến bay</h1>

            @if (ViewBag.ErrorMessage != null)
            {
                <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
            }

            <!-- FORM TÌM KIẾM -->
            <form asp-controller="Home" asp-action="Index" method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger alert alert-danger"></div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="FromAirport" class="form-label">Điểm đi</label>
                        <select asp-for="FromAirport" asp-items="Model.Airports" class="form-select">
                            <option value="">-- Chọn điểm đi --</option>
                        </select>
                        <span asp-validation-for="FromAirport" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="ToAirport" class="form-label">Điểm đến</label>
                        <select asp-for="ToAirport" asp-items="Model.Airports" class="form-select">
                            <option value="">-- Chọn điểm đến --</option>
                        </select>
                        <span asp-validation-for="ToAirport" class="text-danger"></span>
                    </div>
                    <div class="col-md-12">
                        <label asp-for="DepartureDate" class="form-label">Ngày đi</label>
                        <input asp-for="DepartureDate" type="date" class="form-control" />
                        <span asp-validation-for="DepartureDate" class="text-danger"></span>
                    </div>
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">Tìm kiếm</button>
                </div>
            </form>

            <hr class="my-5" />

            <!-- HIỂN THỊ KẾT QUẢ TÌM KIẾM -->
            @if (Model.SearchResults != null)
            {
                <h3 class="text-center mb-3">Kết quả tìm kiếm</h3>

                @if (!Model.SearchResults.Any())
                {
                    <p class="text-center text-muted">Không tìm thấy chuyến bay nào phù hợp.</p>
                }
                else
                {
                    foreach (var flight in Model.SearchResults)
                    {
                        <div class="card mb-3 shadow-sm">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h5 class="card-title">@flight.Airline.AirlineName (@flight.FlightNumber)</h5>
                                        <p class="card-text mb-1">
                                            <strong>Từ:</strong> @flight.DepartureAirport.AirportName (@flight.DepartureAirportCode)
                                        </p>
                                        <p class="card-text">
                                            <strong>Đến:</strong> @flight.ArrivalAirport.AirportName (@flight.ArrivalAirportCode)
                                        </p>
                                        <p>
                                            <strong>Cất cánh:</strong> @flight.DepartureTime.ToString("dd/MM/yyyy HH:mm")
                                            <br />
                                            <strong>Hạ cánh:</strong> @flight.ArrivalTime.ToString("dd/MM/yyyy HH:mm")
                                        </p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        @if (flight.Prices != null && flight.Prices.Any())
                                        {
                                            <h5 class="text-danger">
                                                @flight.Prices.Min(p => p.Price).ToString("N0") VNĐ
                                            </h5>
                                            <p class="text-muted">(Giá thấp nhất)</p>
                                        }
                                        else
                                        {
                                            <p class="text-muted">Hết vé</p>
                                        }

                                        <!-- Nút Đặt vé (Hoàn chỉnh) -->
                                        <a asp-controller="Booking" asp-action="Create" asp-route-flightId="@flight.FlightId"
                                           class="btn btn-success w-100">Chọn vé</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            }
        </div>
    </div>
</div>